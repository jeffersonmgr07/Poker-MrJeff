<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maquinita ‚Äî Frutas (7 por lado)</title>
  <style>
    :root{
      --bg:#070b18;
      --cab:#cfd6e6;
      --cab2:#bfc7dc;
      --panel:#121a36;
      --panel2:#0e1430;
      --glass:#0b1230;
      --text:#eef2ff;
      --muted:#b7c2ea;
      --gold:#ffd166;
      --violet:#7c5cff;
      --good:#48e08b;
      --bad:#ff4d6d;
      --shadow: 0 16px 40px rgba(0,0,0,.38);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 650px at 20% 10%, rgba(124,92,255,.28), transparent 60%),
                  radial-gradient(900px 650px at 85% 20%, rgba(255,209,102,.16), transparent 58%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px;
    }

    .cabinet{
      width:min(980px, 100%);
      border-radius: calc(var(--r) + 10px);
      background: linear-gradient(180deg, rgba(255,255,255,.38), rgba(255,255,255,.15));
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.28);
      overflow:hidden;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      background: linear-gradient(90deg, rgba(124,92,255,.30), rgba(255,209,102,.18));
      border-bottom: 1px solid rgba(0,0,0,.15);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 50%),
                  linear-gradient(135deg, rgba(124,92,255,.95), rgba(255,209,102,.95));
      display:grid;place-items:center;
      font-size:22px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    h1{margin:0; font-size:16px; letter-spacing:.2px; color:#0a1022}
    .sub{margin:2px 0 0; font-size:12px; color: rgba(10,16,34,.75)}

    main{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      padding:16px;
      background: linear-gradient(180deg, rgba(207,214,230,.55), rgba(191,199,220,.30));
    }
    @media (max-width: 920px){ main{grid-template-columns:1fr} }

    /* ===== PANTALLA / TABLERO ===== */
    .screen{
      background: linear-gradient(180deg, rgba(18,26,54,.95), rgba(14,20,48,.95));
      border: 2px solid rgba(0,0,0,.25);
      border-radius: var(--r);
      box-shadow: 0 14px 26px rgba(0,0,0,.28);
      padding:14px;
    }

    /* LEDS arriba */
    .ledRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .led{
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.30));
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.25) inset;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .led .label{
      font-size:12px;
      letter-spacing:.35px;
      color:rgba(255,255,255,.70);
      font-weight:900;
      text-transform:uppercase;
    }
    .digits{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:18px;
      font-weight:900;
      letter-spacing:2px;
      padding:6px 10px;
      border-radius: 12px;
      background: rgba(72,224,139,.10);
      border:1px solid rgba(72,224,139,.25);
      color:#d7ffe9;
      font-variant-numeric: tabular-nums;
      min-width:120px;
      text-align:right;
    }
    .digits.gold{
      background: rgba(255,209,102,.10);
      border-color: rgba(255,209,102,.25);
      color:#ffe9b6;
    }

    /* Tablero 7x7 (per√≠metro visible, centro reservado) */
    .board{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      padding:12px;
    }
    .grid7{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      align-items:stretch;
    }

    .cell{
      height:58px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      user-select:none;
      overflow:hidden;
    }
    .cell .sym{font-size:24px}
    .cell .mult{
      position:absolute;
      top:6px; right:8px;
      font-size:11px;
      color:rgba(255,255,255,.75);
      font-weight:900;
    }
    .cell.bar{
      background: rgba(255,209,102,.10);
      border-color: rgba(255,209,102,.35);
    }
    .cell.active{
      border-color: rgba(255,209,102,.80);
      box-shadow: 0 0 0 3px rgba(255,209,102,.20), 0 10px 18px rgba(255,209,102,.10);
      background: rgba(255,209,102,.12);
    }
    .cell.win{
      border-color: rgba(72,224,139,.85);
      box-shadow: 0 0 0 3px rgba(72,224,139,.22);
      background: rgba(72,224,139,.10);
    }

    /* Centro (ocupa 5x5) */
    .center{
      grid-column: 2 / 7;   /* columnas 2..6 */
      grid-row: 2 / 7;      /* filas 2..6 */
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.12);
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      min-height: 340px;
    }
    .centerTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .marquee{
      font-weight:900;
      letter-spacing:.3px;
      font-size:12px;
      text-transform:uppercase;
      background: linear-gradient(90deg, rgba(124,92,255,.35), rgba(255,209,102,.25));
      border: 1px solid rgba(255,255,255,.14);
      padding:8px 10px;
      border-radius: 999px;
    }
    .badge{
      padding:6px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      white-space:nowrap;
    }
    .badge.win{background: rgba(72,224,139,.16); border-color: rgba(72,224,139,.30); color:#d7ffe9}
    .badge.lose{background: rgba(255,77,109,.14); border-color: rgba(255,77,109,.28); color:#ffd6de}

    .centerArt{
      flex:1;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      padding:12px;
      color:rgba(255,255,255,.85);
      text-align:center;
      line-height:1.35;
    }
    .bigSym{font-size:64px; margin-bottom:6px}
    .centerMsg{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:13px;
      min-height:46px;
    }

    /* ===== PANEL DERECHO / CONTROLES ===== */
    .controls{
      background: linear-gradient(180deg, rgba(18,26,54,.95), rgba(14,20,48,.95));
      border: 2px solid rgba(0,0,0,.25);
      border-radius: var(--r);
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
      padding:14px;
    }
    .controls h2{
      margin:0 0 10px;
      color:var(--text);
      font-size:13px;
      letter-spacing:.2px;
      text-transform:uppercase;
      display:flex; align-items:center; gap:10px;
    }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .btn{
      border:0;
      border-radius: 16px;
      padding:12px 12px;
      font-weight:1000;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:active{transform: translateY(1px)}
    .btn:disabled{cursor:not-allowed; filter: grayscale(.35) brightness(.85)}
    .btn.small{
      background: rgba(255,255,255,.10);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
    }
    .btn.spin{
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--gold), var(--violet));
      color:#0a1022;
      box-shadow: 0 12px 22px rgba(124,92,255,.18);
    }

    /* ===== 2 FILAS DE 8 RECUADROS ===== */
    .choose{
      margin-top:10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:12px;
    }
    .chooseTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      color:var(--muted);
      font-size:12px;
    }

    .row8{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:8px;
    }
    .box{
      height:52px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      user-select:none;
      text-align:center;
      padding:6px;
    }
    .box .top{
      position:absolute;
      top:6px; left:8px;
      font-size:11px;
      color:rgba(255,255,255,.70);
      font-weight:900;
    }
    .box .mid{
      font-size:14px;
      font-weight:1000;
      color:var(--text);
      line-height:1.1;
    }
    .box .sym{font-size:20px; margin-left:6px}
    .box.count{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
      font-variant-numeric: tabular-nums;
      font-weight:1000;
      color:#fff;
    }
    .box.toggle{
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .box.toggle:active{transform: translateY(1px)}
    .box.toggle.on{
      background: rgba(255,209,102,.12);
      border-color: rgba(255,209,102,.45);
      box-shadow: 0 0 0 3px rgba(255,209,102,.14);
    }
    .tiny{
      margin:10px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="cabinet">
    <header>
      <div class="brand">
        <div class="logo">üé∞</div>
        <div>
          <h1>Maquinita ‚Äî 7 por lado + selecci√≥n de frutas</h1>
          <div class="sub">BAR arriba ‚Ä¢ LEDs de premios y cr√©ditos ‚Ä¢ toggles abajo</div>
        </div>
      </div>
    </header>

    <main>
      <!-- IZQUIERDA: LEDS + TABLERO -->
      <section class="screen">
        <div class="ledRow">
          <div class="led">
            <div class="label">PREMIOS</div>
            <div class="digits gold" id="ledPremios">0000</div>
          </div>
          <div class="led">
            <div class="label">CR√âDITOS</div>
            <div class="digits" id="ledCreditos">0020</div>
          </div>
        </div>

        <div class="board">
          <div class="grid7" id="grid7">
            <!-- Se llena por JS -->
          </div>
        </div>
      </section>

      <!-- DERECHA: CONTROLES + FILAS 8/8 -->
      <aside class="controls">
        <h2>Panel de control</h2>

        <div class="btnRow">
          <button class="btn small" id="addCredits">Insertar cr√©dito (+10)</button>
          <button class="btn small" id="reset">Reiniciar</button>
          <button class="btn spin" id="spin">GIRAR üé≤</button>
        </div>

        <div class="choose">
          <div class="chooseTitle">
            <span>Fila superior: apuesta elegida (n√∫mero)</span>
            <span>Fila inferior: toggles (descuenta 1 cr√©dito)</span>
          </div>

          <!-- Fila superior (n√∫meros de fruta elegida) -->
          <div class="row8" id="countsRow"></div>

          <div style="height:10px"></div>

          <!-- Fila inferior (toggles en orden pedido) -->
          <div class="row8" id="togglesRow"></div>

          <p class="tiny">
            Regla: cada toggle ON = <b>1 cr√©dito apostado</b> a esa fruta.
            Al girar, si cae en esa fruta: <b>paga</b> (apuesta √ó multiplicador).<br/>
            Si cae en <b>BAR</b> y apostaste a <b>Fruta Kings</b>, paga alto.
          </p>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ===== CONFIG: frutas en orden EXACTO (toggles) =====
    const FRUITS = [
      { key:"kings",  name:"Fruta Kings", sym:"üëë" },
      { key:"water",  name:"Sand√≠a",      sym:"üçâ" },
      { key:"star",   name:"Estrella",    sym:"‚≠ê" },
      { key:"pear",   name:"Pera",        sym:"üçê" },
      { key:"apple",  name:"Manzana",     sym:"üçé" },
      { key:"lime",   name:"Lima",        sym:"üçã" }, // (es ‚Äúlime‚Äù/lima, emoji lim√≥n)
      { key:"banana", name:"Banana",      sym:"üçå" },
      { key:"cherry", name:"Cereza",      sym:"üçí" },
    ];

    // ===== ESTADO =====
    let credits = 20;
    let premios = 0;
    let spinning = false;

    // apuestas: 0/1 por fruta (toggle)
    const bet = Object.fromEntries(FRUITS.map(f => [f.key, 0]));

    // ===== DOM =====
    const ledCreditos = document.getElementById("ledCreditos");
    const ledPremios = document.getElementById("ledPremios");
    const grid7 = document.getElementById("grid7");
    const countsRow = document.getElementById("countsRow");
    const togglesRow = document.getElementById("togglesRow");

    const btnSpin = document.getElementById("spin");
    const btnAdd = document.getElementById("addCredits");
    const btnReset = document.getElementById("reset");

    // Centro UI
    let centerBadge, centerMsg, centerBig, centerText;

    // ===== TABLERO 7x7 =====
    // Per√≠metro = 24 casillas: 7 arriba + 7 derecha + 7 abajo + 7 izquierda - 4 esquinas repetidas
    // Top-center (col 4, fila 1) es BAR.
    // El centro (5x5) es un panel √∫nico.

    // Definimos las 24 casillas del borde en orden de recorrido (path).
    // Coordenadas 1..7 para fila/col.
    const pathCoords = [];
    // Arriba: (1,1) a (1,7)
    for(let c=1;c<=7;c++) pathCoords.push([1,c]);
    // Derecha: (2,7) a (7,7)
    for(let r=2;r<=7;r++) pathCoords.push([r,7]);
    // Abajo: (7,6) a (7,1)
    for(let c=6;c>=1;c--) pathCoords.push([7,c]);
    // Izquierda: (6,1) a (2,1)
    for(let r=6;r>=2;r--) pathCoords.push([r,1]);

    // Mapa coord -> √≠ndice en path
    const coordToIndex = new Map(pathCoords.map((xy,i)=>[xy.join(","), i]));

    // Distribuci√≥n de s√≠mbolos en el borde (incluye BAR fijo)
    // BAR est√° en (1,4)
    const BAR_COORD = "1,4";

    // Multiplicadores por casilla (BAR paga especial)
    function getMultiplier(coordKey, fruitKeyOrBar){
      if(coordKey === BAR_COORD) return 12; // BAR fuerte
      // Ajusta a tu gusto
      const base = {
        kings: 6,
        water: 5,
        star: 10,
        pear: 3,
        apple: 3,
        lime: 3,
        banana: 4,
        cherry: 4,
      };
      return base[fruitKeyOrBar] ?? 2;
    }

    // Genera un borde con frutas mezcladas (BAR fijo)
    function buildBorderLayout(){
      // Lista de keys para rellenar 23 celdas (menos BAR)
      // damos m√°s aparici√≥n a frutas comunes, menos a estrella y kings
      const pool = [
        ...Array(4).fill("cherry"),
        ...Array(4).fill("banana"),
        ...Array(4).fill("lime"),
        ...Array(4).fill("apple"),
        ...Array(3).fill("pear"),
        ...Array(2).fill("water"),
        ...Array(1).fill("star"),
        ...Array(1).fill("kings"),
      ];
      // shuffle
      for(let i=pool.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [pool[i],pool[j]] = [pool[j],pool[i]];
      }

      const border = new Map(); // coordKey -> {type, key, sym, mult}
      let p = 0;
      for(const [r,c] of pathCoords){
        const ck = `${r},${c}`;
        if(ck === BAR_COORD){
          border.set(ck, { type:"bar", key:"bar", sym:"BAR", mult:getMultiplier(ck,"bar") });
        } else {
          const fruitKey = pool[p++ % pool.length];
          const fruit = FRUITS.find(f=>f.key===fruitKey);
          border.set(ck, { type:"fruit", key:fruitKey, sym:fruit.sym, mult:getMultiplier(ck,fruitKey) });
        }
      }
      return border;
    }

    let borderLayout = buildBorderLayout();

    // Construye UI 7x7
    function renderBoard(){
      grid7.innerHTML = "";

      // Creamos 49 slots (7x7)
      for(let r=1;r<=7;r++){
        for(let c=1;c<=7;c++){
          const isCenter = (r>=2 && r<=6 && c>=2 && c<=6);
          const ck = `${r},${c}`;

          // Centro ocupa 5x5: lo dibujamos una sola vez en (2,2)
          if(isCenter){
            if(r===2 && c===2){
              const center = document.createElement("div");
              center.className = "center";

              center.innerHTML = `
                <div class="centerTop">
                  <div class="marquee">PANEL CENTRAL</div>
                  <div class="badge" id="centerBadge">Listo</div>
                </div>
                <div class="centerArt">
                  <div>
                    <div class="bigSym" id="centerBig">üé∞</div>
                    <div id="centerText">Elige frutas abajo (toggles) y pulsa <b>GIRAR</b>.</div>
                  </div>
                </div>
                <div class="centerMsg">
                  <div id="centerMsg">BAR est√° arriba al centro.</div>
                  <div class="badge" id="resultBadge">‚Äî</div>
                </div>
              `;
              grid7.appendChild(center);

              // Guardamos refs
              centerBadge = center.querySelector("#centerBadge");
              centerMsg = center.querySelector("#centerMsg");
              centerBig = center.querySelector("#centerBig");
              centerText = center.querySelector("#centerText");
              window.resultBadge = center.querySelector("#resultBadge");
            }
            continue;
          }

          // Borde
          const cell = document.createElement("div");
          const data = borderLayout.get(ck);
          cell.className = "cell" + (data?.type==="bar" ? " bar" : "");
          cell.dataset.coord = ck;

          if(data?.type==="bar"){
            cell.innerHTML = `<span class="sym" style="font-size:16px;font-weight:1000;letter-spacing:1px">${data.sym}</span>
                              <span class="mult">x${data.mult}</span>`;
          } else {
            cell.innerHTML = `<span class="sym">${data?.sym ?? "‚ùì"}</span>
                              <span class="mult">x${data?.mult ?? 2}</span>`;
          }
          grid7.appendChild(cell);
        }
      }
    }

    // ===== FILAS 8/8 =====
    function renderRows(){
      // Fila superior: n√∫meros (0/1) por fruta
      countsRow.innerHTML = "";
      for(const f of FRUITS){
        const box = document.createElement("div");
        box.className = "box count";
        box.id = `count-${f.key}`;
        box.innerHTML = `<div class="top">${f.sym}</div><div class="mid">${bet[f.key]}</div>`;
        countsRow.appendChild(box);
      }

      // Fila inferior: toggles
      togglesRow.innerHTML = "";
      for(const f of FRUITS){
        const box = document.createElement("div");
        box.className = "box toggle";
        box.id = `toggle-${f.key}`;
        box.innerHTML = `<div class="mid">${f.name}</div><div class="sym">${f.sym}</div>`;
        box.addEventListener("click", () => toggleFruit(f.key));
        togglesRow.appendChild(box);
      }
      syncToggleUI();
    }

    function syncToggleUI(){
      for(const f of FRUITS){
        const t = document.getElementById(`toggle-${f.key}`);
        const c = document.getElementById(`count-${f.key}`);
        const on = bet[f.key] === 1;
        t.classList.toggle("on", on);
        c.querySelector(".mid").textContent = bet[f.key].toString();
      }
    }

    // ===== UTIL =====
    function pad4(n){
      n = Math.max(0, Math.floor(n));
      return String(n).padStart(4,"0");
    }

    function setBadge(el, type, text){
      el.classList.remove("win","lose");
      if(type) el.classList.add(type);
      el.textContent = text;
    }

    function renderLeds(){
      ledCreditos.textContent = pad4(credits);
      ledPremios.textContent = pad4(premios);
      // bot√≥n girar solo si hay alguna apuesta activa
      const anyBet = FRUITS.some(f => bet[f.key] === 1);
      btnSpin.disabled = spinning || !anyBet;
    }

    function totalBet(){
      return FRUITS.reduce((sum,f)=>sum + bet[f.key], 0);
    }

    // Toggle: ON descuenta 1 cr√©dito, OFF devuelve 1 cr√©dito
    function toggleFruit(key){
      if(spinning) return;

      if(bet[key] === 0){
        if(credits <= 0){
          setBadge(centerBadge, "lose", "Sin cr√©dito");
          centerMsg.textContent = "No tienes cr√©ditos para apostar.";
          return;
        }
        bet[key] = 1;
        credits -= 1;
        setBadge(centerBadge, null, "Listo");
        centerMsg.textContent = `Apostaste a ${FRUITS.find(f=>f.key===key).name} (-1 cr√©dito).`;
      } else {
        bet[key] = 0;
        credits += 1;
        setBadge(centerBadge, null, "Listo");
        centerMsg.textContent = `Quitaste apuesta de ${FRUITS.find(f=>f.key===key).name} (+1 cr√©dito).`;
      }

      syncToggleUI();
      renderLeds();
    }

    // ===== ANIMACI√ìN DE LUCES (RECORRIDO EN EL BORDE) =====
    function clearHighlights(){
      document.querySelectorAll(".cell").forEach(c => c.classList.remove("active","win"));
    }
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    async function spin(){
      if(spinning) return;
      const anyBet = FRUITS.some(f => bet[f.key] === 1);
      if(!anyBet){
        setBadge(centerBadge, "lose", "Apuesta");
        centerMsg.textContent = "Elige al menos una fruta (toggle).";
        return;
      }

      spinning = true;
      btnSpin.disabled = true;
      clearHighlights();

      setBadge(centerBadge, null, "Girando");
      window.resultBadge.classList.remove("win","lose");
      window.resultBadge.textContent = "‚Äî";
      centerBig.textContent = "‚ú®";
      centerText.textContent = "Corriendo luces‚Ä¶";
      centerMsg.textContent = "¬°Suerte!";

      // velocidad y frenado
      const spd = 5; // fija (si quieres slider lo agrego)
      const baseTick = 150 - spd * 10;
      const minSteps = 42 + spd * 6;
      const extra = Math.floor(Math.random() * 26);
      const steps = minSteps + extra;

      let idx = Math.floor(Math.random() * pathCoords.length);

      for(let s=0; s<steps; s++){
        clearHighlights();
        const [r,c] = pathCoords[idx];
        const ck = `${r},${c}`;
        const el = document.querySelector(`.cell[data-coord="${ck}"]`);
        el?.classList.add("active");

        const t = baseTick + Math.max(0, (s - (steps-14))) * 20;
        await sleep(t);

        idx = (idx + 1) % pathCoords.length;
      }

      // final = anterior
      const finalIdx = (idx - 1 + pathCoords.length) % pathCoords.length;
      const [fr,fc] = pathCoords[finalIdx];
      const finalKey = `${fr},${fc}`;
      const finalEl = document.querySelector(`.cell[data-coord="${finalKey}"]`);
      const data = borderLayout.get(finalKey);

      clearHighlights();
      finalEl?.classList.add("active","win");

      // Determinar pago
      let win = 0;
      let label = "";

      if(finalKey === BAR_COORD){
        // BAR: paga si apostaste a Kings
        if(bet.kings === 1){
          win = 1 * data.mult; // apuesta (1) * mult
          label = `BAR (Kings) x${data.mult}`;
          centerBig.textContent = "üÖ±Ô∏è";
        } else {
          label = `BAR x${data.mult}`;
          centerBig.textContent = "üÖ±Ô∏è";
        }
      } else {
        const fk = data.key; // fruta key
        const b = bet[fk] ?? 0;
        if(b > 0){
          win = b * data.mult;
          label = `${data.sym} x${data.mult}`;
          centerBig.textContent = data.sym;
        } else {
          label = `${data.sym} x${data.mult}`;
          centerBig.textContent = data.sym;
        }
      }

      // Reset de apuestas despu√©s de girar (estilo ‚Äúconsumir apuesta‚Äù)
      // (ya se descont√≥ cuando activaste toggle; ahora simplemente se limpian)
      for(const f of FRUITS) bet[f.key] = 0;
      syncToggleUI();

      if(win > 0){
        credits += win;
        premios += win;
        setBadge(centerBadge, "win", "¬°Premio!");
        window.resultBadge.classList.add("win");
        window.resultBadge.textContent = `+${win}`;
        centerText.innerHTML = `Cay√≥ en <b>${label}</b>`;
        centerMsg.innerHTML = `Ganaste <b>${win}</b> cr√©dito(s).`;
      } else {
        setBadge(centerBadge, "lose", "Nada");
        window.resultBadge.classList.add("lose");
        window.resultBadge.textContent = `0`;
        centerText.innerHTML = `Cay√≥ en <b>${label}</b>`;
        centerMsg.textContent = "No apostaste a esa casilla.";
      }

      renderLeds();
      spinning = false;
      btnSpin.disabled = false;
    }

    // ===== BOTONES =====
    btnAdd.addEventListener("click", () => {
      if(spinning) return;
      credits += 10;
      setBadge(centerBadge, null, "Listo");
      centerMsg.textContent = "Insertaste +10 cr√©ditos.";
      renderLeds();
    });

    btnReset.addEventListener("click", () => {
      spinning = false;
      credits = 20;
      premios = 0;
      for(const f of FRUITS) bet[f.key] = 0;
      borderLayout = buildBorderLayout();
      renderBoard();
      renderRows();
      clearHighlights();
      setBadge(centerBadge, null, "Listo");
      window.resultBadge.textContent = "‚Äî";
      centerBig.textContent = "üé∞";
      centerText.innerHTML = `Elige frutas abajo (toggles) y pulsa <b>GIRAR</b>.`;
      centerMsg.textContent = "BAR est√° arriba al centro.";
      renderLeds();
    });

    btnSpin.addEventListener("click", spin);

    // ===== INIT =====
    renderBoard();
    renderRows();
    renderLeds();
  </script>
</body>
</html>
